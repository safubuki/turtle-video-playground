# デグレ防止チェックリスト

バグ修正・機能追加時に確認すべきデグレ防止のチェックポイントをまとめたドキュメントです。
各修正の影響範囲に応じて、該当する項目を確認してください。

---

## 1. 修正前チェック（必須）

### 1-1. オーバービュー参照

- [ ] プロジェクトオーバービュースキル（`*-overview`）の全リファレンスを読み込んだか
- [ ] 今回の修正に関連する既存の実装パターン・注意点を特定したか
- [ ] 今回の修正が既存のワークアラウンドと競合しないことを確認したか

### 1-2. 影響範囲の特定

- [ ] 変更対象ファイルをすべてリストアップしたか
- [ ] 変更対象ファイルが参照している他のファイル（import先）を確認したか
- [ ] 変更対象のコンポーネント・フック・ストアの使用箇所を確認したか
- [ ] 新しい props や引数を追加する場合、呼び出し元をすべて更新したか

---

## 2. 実装時チェック

### 2-1. 既存パターンの保護

| チェック項目 | 関連パターン |
|-------------|-------------|
| `display: none` を使っていないか | ブラックアウト対策（`opacity: 0.001` パターン） |
| `URL.createObjectURL` を使ったら `revokeObjectURL` があるか | メモリ管理（ObjectURL 解放） |
| `AudioContext` 操作に `catch` を付けているか | AudioContext 管理 |
| `VideoFrame` を `close()` しているか | WebCodecs メモリ管理 |
| `visibilitychange` リスナーをクリーンアップしているか | タブ復帰対策 |
| Ref + State の並行管理パターンを維持しているか | 状態管理パターン |
| `loopIdRef` による世代管理と矛盾しないか | 再生ループ管理 |
| `playsInline` 属性を付与しているか（video 要素追加時） | モバイル対応 |
| 長時間実行の処理に `AbortController` を付けているか | エクスポート中断 |

### 2-2. コードスタイルの一貫性

- [ ] 既存のコーディング規約（TypeScript strict、ESLint + Prettier）に従っているか
- [ ] 命名規則がプロジェクトの慣例と一致しているか
- [ ] `useCallback` / `useMemo` を適切に使用しているか
- [ ] 新規コンポーネントに `React.memo` の適用を検討したか
- [ ] 型定義を `src/types/index.ts` に追加しているか（新しい型が必要な場合）

### 2-3. エラーハンドリング

- [ ] 新しい処理に適切な `try-catch` を追加しているか
- [ ] `ErrorBoundary` 内のコンポーネントか確認したか（コンポーネント層の防御）
- [ ] ユーザーに表示するエラーメッセージが適切か（`showToast` / `setError` の使用）

---

## 3. 修正後チェック（必須）

### 3-1. テスト実行

- [ ] `npm run test:run` で全テストが合格したか
- [ ] 新しいテストの追加は必要か（特にストアやユーティリティの変更時）

### 3-2. ビルド確認

- [ ] `npm run build` が成功したか（TypeScript コンパイル + Vite ビルド）
- [ ] 型エラーが発生していないか

### 3-3. IDE エラーチェック

- [ ] 変更したファイルに IDE のエラー表示がないか
- [ ] 関連ファイルにも新しいエラーが発生していないか

---

## 4. オーバービュー更新チェック（必須）

- [ ] 今回の対応内容をオーバービュースキルのリファレンスに追記したか
- [ ] 追記が既存の記述を上書きしていないか
- [ ] 追記のフォーマットが既存の記述スタイルと一致しているか
- [ ] 横断的注意点テーブルへの追記が必要か確認したか

---

## 5. 危険度別の追加チェック

### 🔴 高リスク（再生・描画・エクスポートに関わる変更）

- [ ] `renderFrame` の変更が再生・シーク・エクスポートすべてで正しく動作するか
- [ ] `startEngine` / `stopAll` の変更が再生ライフサイクル全体に影響しないか
- [ ] Canvas 描画の変更がキャプション表示・フェードに影響しないか
- [ ] オーディオルーティングの変更が通常再生・エクスポート両方で正しいか

### 🟠 中リスク（ストア・状態管理の変更）

- [ ] ストアの変更が `restoreFromSave` と互換性があるか
- [ ] 新しい状態が自動保存の変更検知（ハッシュ計算）に含まれるべきか
- [ ] IndexedDB の保存・復元に影響はないか

### 🟢 低リスク（UI・スタイルの変更）

- [ ] レスポンシブ対応を確認したか（モバイル表示）
- [ ] アクセシビリティ（`disabled` 状態、`title` 属性等）を考慮したか
