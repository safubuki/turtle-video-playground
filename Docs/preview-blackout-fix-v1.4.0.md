# プレビュー画面ブラックアウト・動画固まり問題の修正

**対応バージョン**: v1.4.0  
**対応日**: 2026年1月29日

---

## 現象

### 現象1: BGM/ナレーション追加後に動画が固まる
- **発生条件**: 動画2本、静止画1本（計約20秒）を追加後、1分のBGMまたはナレーションを追加
- **症状**: 
  - 動画が完全に固まり、静止画しか表示されなくなる
  - シークバーは動作し、BGM/ナレーションは再生される
  - 固定された動画フレームが表示され続ける
- **発生タイミング**: シークバーを移動したときに発生しやすい

### 現象2: シークバー操作時のカクつき
- **発生条件**: シークバーをドラッグ操作
- **症状**: プレビュー画面がカクつき、スムーズに追従しない

### 現象3: トリミング時のブラックアウト
- **発生条件**: 動画1、動画2、画像3、画像4を追加し、動画2をトリミング
- **症状**: 動画1が高確率でブラックアウトする

---

## 原因

### 根本原因: シーク状態管理の不備

1. **`isSeekingRef`のリセット漏れ**: シークバー操作完了時に、シーク状態フラグが条件付きでしかリセットされず、`true`のまま残り続けるケースがあった

2. **`renderFrame`内のビデオ制御ロジックの問題**: ユーザーのシークバー操作中とビデオ要素のシーク処理中を同一視していたため、両方の状態で再生/停止制御がスキップされていた

3. **`syncVideoToTime`のしきい値が大きすぎた**: ビデオ位置同期のしきい値が0.3秒と大きく、小さなシーク操作ではビデオ位置が更新されなかった

4. **AudioContext操作時のエラー無視**: BGM/ナレーション追加時のAudioContext操作で発生するエラーが無視され、問題の特定が困難だった

---

## 過去の対応とその効果

### 効果が限定的だった対応

| 対応内容 | 効果がなかった理由 |
|----------|-------------------|
| **holdFrameロジック追加**（ビデオ未準備時にキャンバスをクリアしない） | ブラックアウトの見た目は軽減したが、ビデオ自体が再生されない根本問題は解決していなかった |
| **MediaResourceLoaderの個別メモ化** | トリミング時の不要な再レンダリングは防げたが、シーク状態管理の問題は残ったまま |
| **オーディオノードのクリーンアップ処理追加** | メディア削除時のリソースリークは防げたが、追加時の問題には対応していなかった |
| **State sync useEffectからcurrentTime依存を削除** | 過剰な再レンダリングは減ったが、シーク状態のリセット漏れは解決していなかった |
| **seekingVideosRefによるシーク中ビデオ追跡** | 複雑さが増しただけで、根本的なシーク状態管理の問題を隠蔽していた |

### なぜ改善しなかったのか

1. **症状への対症療法に終始**: ブラックアウトやカクつきという「見た目の症状」に対処しようとしたが、「なぜビデオが再生されないのか」という根本原因の追跡が不十分だった

2. **状態管理の複雑化**: `seekingVideosRef`などの追加状態を導入することで、かえってバグの発生源が増えた

3. **条件分岐の見落とし**: `handleSeekEnd`内の条件分岐で、シーク状態がリセットされないパスが存在することを見落としていた

4. **AudioContextとビデオ再生の関連性を軽視**: BGM/ナレーション追加がビデオ再生に影響を与えるメカニズムの理解が不足していた

---

## 今回の対応（効果的だった対応）

### 対応1: `handleSeekEnd`の改善
シーク状態を条件に関わらず**必ずリセット**し、非再生時も再描画を行うよう変更。

### 対応2: `renderFrame`内のビデオ制御ロジック改善
ユーザーシーク中（`isSeekingRef`）とビデオシーク中（`videoEl.seeking`）を**分離して処理**。ユーザーがシーク操作していなければ、ビデオシーク中でも再生開始を許可。

### 対応3: `syncVideoToTime`のしきい値調整
しきい値を**0.3秒から0.1秒**に変更し、シーク時の追従性を向上。

### 対応4: `handleMediaRefAssign`の改善
AudioContext操作時の**エラーログ出力**とAudioContextがsuspended状態の場合の**復帰処理**を追加。

### 対応5: ビデオ再生条件の緩和
`readyState >= 3`（HAVE_ENOUGH_DATA）から**`readyState >= 2`**（HAVE_CURRENT_DATA）に変更し、より早く再生を開始できるようにした。

---

## 結果

| 項目 | 修正前 | 修正後 |
|------|--------|--------|
| BGM/ナレーション追加後の動画固まり | 高確率で発生 | 解消 |
| シークバー操作時のカクつき | 頻繁に発生 | 大幅に軽減 |
| トリミング時のブラックアウト | 高確率で発生 | 解消 |
| シーク操作後の再生復帰 | 復帰しないケースあり | 確実に復帰 |

---

## 修正ファイル

- `src/components/TurtleVideo.tsx`
  - `handleSeekEnd`: シーク状態のリセットロジック改善
  - `renderFrame`: ビデオ制御ロジック改善
  - `syncVideoToTime`: しきい値調整
  - `handleMediaRefAssign`: エラーログとAudioContext復帰処理追加

---

## 技術的補足

### Web Audio APIとビデオ再生の関係
`MediaElementAudioSourceNode`を作成すると、そのメディア要素の音声出力はWeb Audio APIを経由するようになる。AudioContextがsuspended状態の場合、音声だけでなくビデオの再生にも影響を与える可能性がある。

### シーク状態管理の重要性
シークバー操作中は頻繁に`renderFrame`が呼ばれるため、その間のビデオ制御を適切に管理しないと、再生/停止の競合が発生し、ビデオが固まる原因となる。

### しきい値のトレードオフ
- 大きいしきい値: カクつきは減るが、追従性が低下
- 小さいしきい値: 追従性は上がるが、カクつきが増える可能性
- 0.1秒は実用上のバランスが取れた値

---

## 教訓

1. **症状ではなく原因を追跡する**: 表面的な現象への対処ではなく、「なぜそうなるのか」を深掘りする
2. **状態管理はシンプルに保つ**: 追加の状態変数を導入する前に、既存の状態管理が正しく機能しているか確認する
3. **全てのコードパスを検証する**: 条件分岐がある場合、全てのパスで期待通りの動作になるか確認する
4. **エラーを無視しない**: `catch(e) { /* ignore */ }`は問題の発見を遅らせる
