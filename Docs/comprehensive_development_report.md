# 🐢 TurtleVideo 開発・トラブルシューティング全史レポート

## 📌 はじめに
本レポートは、TurtleVideoプロジェクトの立ち上げから現在に至るまでの技術的な意思決定、直面した困難なバグ、およびその解決策を網羅的に記録したものです。
単なる機能一覧ではなく、**「開発者がどこで躓き、どう乗り越えたか」** に焦点を当て、コミットログとコード差分に基づいたファクトベースの記録として残します。

---

## 📅 第1フェーズ: コアエンジン構築の苦闘 (2026-01-27 ~ 01-28)

この期間は、WebCodecs APIを用いた再生エンジンの基礎構築と、初期のパフォーマンス問題への対処に費やされました。

### 🔴 課題1: シーク時の激しいカクつき (Stuttering)
**Commit**: `4c70867` (Fix video stuttering when seeking between videos via slider)

**現象**
スライダーでシークバーをドラッグすると、映像がスムーズに追従せず、激しく点滅したり停止したりする。

**原因**
Reactのステート更新 (`setCurrentTime`) と、ビデオ要素のシーク (`video.currentTime`) が同期的に高頻度で実行され、ブラウザのデコード処理が追いついていなかった。

**対処: スロットリング (Throttling) の導入**
シーク操作を間引きし、一定間隔（例: 100ms）ごとにのみビデオ要素への命令を送るように変更。

```typescript
// Before
const handleSeek = (t) => {
  videoEl.currentTime = t; // 毎回実行
  renderFrame(t);
}

// After (Concept)
const handleSeek = (t) => {
  renderFrame(t); // UIは即座に更新
  if (now - lastSeekTime > THROTTLE_MS) {
     videoEl.currentTime = t; // 重い処理は間引く
     lastSeekTime = now;
  } else {
     schedulePendingSeek(t); // 飛ばされた分は後で実行
  }
}
```

### � 課題2: 画像から動画への遷移時の遅延
**Commit**: `8a73088` (Fix video stuttering when transitioning from image to video)

**現象**
タイムライン上で「画像」クリップから「動画」クリップに再生が進む際、一瞬（0.5秒ほど）黒画になったり、動画の開始が遅れる。

**原因**
動画クリップに到達した瞬間に `video.play()` を呼んでいたため、デコーダの立ち上がり待ちが発生していた。

**対処: 先読みロジック (Lookahead Preload)**
再生ヘッドが現在のクリップの終了間際（1.5秒前）に来たら、次のクリップが動画であれば、裏でこっそりシークして準備 (`readyState >= 2`) させておくロジックを追加。

---

## 📅 第2フェーズ: 機能拡張とUX向上 (2026-01-30 ~ 01-31)

基本機能が安定した後、ユーザービリティの向上と機能拡張が行われました。

### � 課題3: 長尺動画ロード中のUIフリーズ操作
**Commit**: `a7520b8` (長尺ロード中にボタン非活性対応)

**現象**
重い動画ファイルを読み込んでいる最中に再生ボタンなどを押せてしまい、エラーが発生したりアプリがクラッシュする。

**対処: ローディング状態の厳格化**
`isLoading`, `isProcessing` フラグを整備し、リソース準備中はUI全体を適切にブロック（非活性化）するように変更。

### 🟠 課題4: 調整作業の視認性向上
**Commit**: `0f529c8` (feat: MiniPreview コンポーネントを追加)

**現象**
動画の拡大・縮小や位置調整を行う際、メインプレビューを見ながらスライダーを操作するのが直感的でなかった（視線移動が大きい）。

**対処: ミニプレビューの実装**
トランスフォームパネル内に、当該クリップだけを表示する小さなプレビュー画面を実装。
**技術的挑戦**:
メインのCanvasとは別に、オフスクリーンCanvasのような軽量な描画コンテキストを持つ必要があった。パフォーマンスを維持するため、`React.memo` で徹底的に再描画を抑制した。

---

## 📅 第3フェーズ: 安定化と非同期処理の闇 (2026-02-01)

ここが最大の山場でした。複雑な操作におけるエッジケースのバグ修正です。

### � 課題5: 動画切り替え直後の停止によるフリーズ (Critical)
**Commit**: `7d22937` (Latest Fix)

**現象**
動画切り替え直後（ロード中）に「停止」を押すとタイムアウト・フリーズする。
（詳細は前述のバグフィックスレポート参照）

**真因**
停止処理における「全リソース再構築 (`handleReloadResources`)」が、ロード中のブラウザ処理と競合していた。

**対処**
「停止」の意味を再定義。「リソース破棄」から「状態リセット（一時停止＆シーク）」へと変更し、DOMを維持することで競合を回避。

### 🟡 課題6: 型安全性の欠如
**現象**
WebCodecs API (`VideoEncoder` 等) の型定義がなく、開発効率と安全性が低下。

**対処**
`src/types/webcodecs.d.ts` を作成し、プロジェクト独自の型定義を追加。

---

## 📊 技術的総括と統計

### コミット統計
- **総コミット数**: 100+
- **開発ピーク**: 2026-01-28 (56 commits/day)
- **修正された主要バグ**: 10件以上

### アーキテクチャの変遷
1. **初期**: 単純な React State で全管理 → パフォーマンス劣化
2. **中期**: `useRef` を多用したレンダリング回避、`requestAnimationFrame` ループの最適化
3. **現在**: 状態（Zustand）と描画（Canvas/Ref）の明確な分離、非同期処理の競合回避設計

### 今後の展望
現在のコードベースは、非同期処理の複雑さを吸収しうる堅牢な設計になっています。
次は「複数トラック編集」や「より高度なエフェクト（WebGL）」への拡張が可能な状態です。

*Report created by Antigravity Agent on 2026-02-01*
